**å¼€å‘è€…å‰è¨€ï¼š**

**æœ¬ç¨‹åºæ˜¯æˆ‘åœ¨å¼€å‘apkä¸€ä½“è‡ªåŠ¨åŒ–åˆ†æé¡¹ç›®æ—¶çš„ä¸€ä¸ªå…¶ä¸­ä¸€ä¸ªæ¨¡å—ï¼Œç›®å‰ä»…æ”¯æŒæŠ•å±å’Œé¼ æ ‡å•ç‚¹æ“æ§åŠŸèƒ½ï¼Œå…¶ä»–åŠŸèƒ½æš‚æ—¶ä¸éœ€è¦å®ç°å°±æ²¡åšã€‚ä»£ç ä»…ä¾›å­¦ä¹ ï¼Œæœ‰å¾ˆå¤šä¸å®Œå–„çš„åœ°æ–¹æœ›å¤šæŒ‡æ•™ï¼**

ğŸš©å…¶ä»–ä¾èµ–ï¼š**adb**ï¼ˆä»»æ„ç‰ˆæœ¬ï¼‰ï¼Œ**scrcpy-server**ï¼ˆv3.3.4ï¼Œåªèƒ½è¿™ä¸ªç‰ˆæœ¬ï¼Œå…¶ä»–ç‰ˆæœ¬åè®®ä¸å¯¹ï¼‰ï¼Œéœ€è¦æµè§ˆå™¨æ”¯æŒ**Webcodecs API**ï¼Œå¦åˆ™æ— æ³•åœ¨æµè§ˆå™¨çœ‹åˆ°ç”»é¢ğŸš©*adbå’Œscrcpy-serveræ³¨æ„è·¯å¾„ï¼Œ--helpä¸­ä¼šæœ‰æç¤º*

<img width="200" height="300" alt="image" src="https://github.com/user-attachments/assets/4f6ab07c-c84e-43bc-a889-0d07eb22db18" />


## ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#1-ç³»ç»Ÿæ¦‚è¿°)
2. [æ•´ä½“æ¶æ„](#2-æ•´ä½“æ¶æ„)
3. [å¯åŠ¨æµç¨‹](#3-å¯åŠ¨æµç¨‹)
4. [ADBé€šä¿¡å±‚](#4-adbé€šä¿¡å±‚)
5. [Scrcpy Serveråè®®](#5-scrcpy-serveråè®®)
6. [è§†é¢‘æµå¤„ç†](#6-è§†é¢‘æµå¤„ç†)
7. [æ§åˆ¶æµå¤„ç†](#7-æ§åˆ¶æµå¤„ç†)
8. [WebSocketé€šä¿¡](#8-websocketé€šä¿¡)
9. [å‰ç«¯è§£ç ä¸æ¸²æŸ“](#9-å‰ç«¯è§£ç ä¸æ¸²æŸ“)
10. [æ•°æ®æµè½¬å›¾](#10-æ•°æ®æµè½¬å›¾)
11. [å…³é”®æŠ€æœ¯ç»†èŠ‚](#11-å…³é”®æŠ€æœ¯ç»†èŠ‚)
12. [é…ç½®å‚æ•°è¯´æ˜](#12-é…ç½®å‚æ•°è¯´æ˜)
13. [é”™è¯¯å¤„ç†](#13-é”™è¯¯å¤„ç†)
14. [ç«¯å£è‡ªåŠ¨å¯»æ‰¾æœºåˆ¶](#14-ç«¯å£è‡ªåŠ¨å¯»æ‰¾æœºåˆ¶)

---

## 1. ç³»ç»Ÿæ¦‚è¿°

Rust-Scrcpy æ˜¯ä¸€ä¸ªç”¨ Rust å®ç°çš„ Android å±å¹•é•œåƒç³»ç»Ÿï¼Œé€šè¿‡ ADB ä¸è®¾å¤‡é€šä¿¡ï¼Œä½¿ç”¨ scrcpy-server æ•è·å±å¹•ï¼Œå¹¶é€šè¿‡ WebSocket å°† H.264 è§†é¢‘æµå¹¿æ’­åˆ°æµè§ˆå™¨å®¢æˆ·ç«¯ã€‚åŒæ—¶æ”¯æŒåŒå‘æ§åˆ¶ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡æµè§ˆå™¨è§¦æ§/é¼ æ ‡æ“ä½œè¿œç¨‹æ§åˆ¶ Android è®¾å¤‡ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **å®æ—¶å±å¹•é•œåƒ**: ä½å»¶è¿Ÿ H.264 è§†é¢‘æµä¼ è¾“
- **åŒå‘æ§åˆ¶**: æ”¯æŒè§¦æ‘¸ã€é¼ æ ‡ã€æŒ‰é”®äº‹ä»¶ï¼ˆä»…å•ç‚¹æ§åˆ¶ï¼‰
- **Web å®¢æˆ·ç«¯**: åŸºäº WebCodecs API çš„æµè§ˆå™¨å†…è§£ç 
- **å¤šå®¢æˆ·ç«¯æ”¯æŒ**: ä½¿ç”¨ broadcast channel åŒæ—¶å‘å¤šä¸ªå®¢æˆ·ç«¯æ¨æµ
- **è‡ªåŠ¨ IDR å¸§è¯·æ±‚**: æ–°å®¢æˆ·ç«¯è¿æ¥æ—¶è‡ªåŠ¨è·å–å…³é”®å¸§ï¼Œæé«˜ç”»é¢å“åº”é€Ÿåº¦
- **è‡ªåŠ¨ç«¯å£**ï¼šè‡ªåŠ¨è·³è¿‡å ç”¨çš„ç«¯å£ï¼Œä½¿ç”¨æœªè¢«å ç”¨çš„ç«¯å£

### æŠ€æœ¯æ ˆ

| ç»„ä»¶           | æŠ€æœ¯                       |
| -------------- | -------------------------- |
| åç«¯è¿è¡Œæ—¶     | Tokio (å¼‚æ­¥)               |
| HTTP/WebSocket | Axum                       |
| è§†é¢‘ç¼–ç        | H.264 (Android MediaCodec) |
| å‰ç«¯è§£ç        | WebCodecs API              |
| è¿›ç¨‹é€šä¿¡       | ADB forward + TCP          |

---

## 2. æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Rust-Scrcpy ç³»ç»Ÿæ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ADB      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            Android Device            â”‚ â”‚
â”‚  â”‚   AdbClient  â”‚   (USB/WiFi) â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚              â”‚              â”‚  â”‚       scrcpy-server.jar         â”‚ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚ â”‚
â”‚         â”‚                      â”‚  â”‚  â”‚  Video    â”‚  â”‚  Control   â”‚  â”‚ â”‚ â”‚
â”‚         â”‚                      â”‚  â”‚  â”‚  Encoder  â”‚  â”‚  Handler   â”‚  â”‚ â”‚ â”‚
â”‚         â”‚                      â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚ â”‚ â”‚
â”‚         â”‚                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚         â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                  â”‚               â”‚            â”‚
â”‚         â”‚ adb forward                      â”‚               â”‚            â”‚
â”‚         â”‚ tcp:27183 â†’ localabstract:scrcpy â”‚               â”‚            â”‚
â”‚         â”‚ tcp:27184 â†’ localabstract:scrcpy â”‚               â”‚            â”‚
â”‚         â”‚                                  â”‚               â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              â”‚              â”‚                                      â”‚ â”‚
â”‚  â”‚ ScrcpyServer â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            TCP Streams               â”‚ â”‚
â”‚  â”‚              â”‚   TCP:27183  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   TCP:27184  â”‚  â”‚ Video Port â”‚    â”‚ Control Port â”‚  â”‚ â”‚
â”‚                                â”‚  â”‚   27183    â”‚    â”‚    27184     â”‚  â”‚ â”‚
â”‚                                â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚                 â”‚            â”‚
â”‚                                          â–¼                 â–¼            â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                           â”‚ VideoStreamReader  â”‚  â”‚  ControlChannel  â”‚  â”‚
â”‚                           â”‚ (NAL è§£æå™¨)        â”‚  â”‚  (äº‹ä»¶å‘é€å™¨)    â”‚  â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚                      â”‚            â”‚
â”‚                                     â”‚ Bytes (NAL Units)    â”‚ TouchEvent â”‚
â”‚                                     â–¼                      â–¼            â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                           â”‚           Main Event Loop               â”‚   â”‚
â”‚                           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚                           â”‚  â”‚     tokio::select! {            â”‚    â”‚   â”‚
â”‚                           â”‚  â”‚       video_frame => broadcast, â”‚    â”‚   â”‚
â”‚                           â”‚  â”‚       control_event => send,    â”‚    â”‚   â”‚
â”‚                           â”‚  â”‚       idr_request => cache_send â”‚    â”‚   â”‚
â”‚                           â”‚  â”‚     }                           â”‚    â”‚   â”‚
â”‚                           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                              â”‚                          â”‚
â”‚                                              â”‚ broadcast::Sender<Bytes> â”‚
â”‚                                              â–¼                          â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                           â”‚          WebSocketServer                â”‚   â”‚
â”‚                           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚                           â”‚  â”‚     HTTP: /     â†’ HTMLé¡µé¢      â”‚    â”‚   â”‚
â”‚                           â”‚  â”‚     WS:   /ws   â†’ è§†é¢‘æµ+æ§åˆ¶    â”‚    â”‚   â”‚
â”‚                           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                              â”‚                          â”‚
â”‚                                              â”‚ WebSocket (Binary+Text)  â”‚
â”‚                                              â–¼                          â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                           â”‚            Browser Client               â”‚   â”‚
â”‚                           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚                           â”‚  â”‚  WebCodecs VideoDecoder         â”‚    â”‚   â”‚
â”‚                           â”‚  â”‚  Canvas 2D Rendering            â”‚    â”‚   â”‚
â”‚                           â”‚  â”‚  Touch/Mouse Event Handlers     â”‚    â”‚   â”‚
â”‚                           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. å¯åŠ¨æµç¨‹

### 3.1 å®Œæ•´å¯åŠ¨æ—¶åºå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User  â”‚     â”‚  Main   â”‚     â”‚  AdbClient   â”‚     â”‚  ScrcpyServer   â”‚     â”‚ Device â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚               â”‚                 â”‚                      â”‚                  â”‚
    â”‚ cargo run     â”‚                 â”‚                      â”‚                  â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚                      â”‚                  â”‚
    â”‚               â”‚                 â”‚                      â”‚                  â”‚
    â”‚               â”‚ list_devices()  â”‚                      â”‚                  â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                  â”‚
    â”‚               â”‚                 â”‚    adb devices       â”‚                  â”‚
    â”‚               â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
    â”‚               â”‚                 â”‚                      â”‚                  â”‚
    â”‚               â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                  â”‚
    â”‚               â”‚                 â”‚                      â”‚                  â”‚
    â”‚               â”‚ shell("wm size")â”‚                      â”‚                  â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                  â”‚
    â”‚               â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
    â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   "Physical size: 1080x1920"            â”‚
    â”‚               â”‚                 â”‚                      â”‚                  â”‚
    â”‚               â”‚ deploy()        â”‚                      â”‚                  â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                  â”‚
    â”‚               â”‚                 â”‚    adb push          â”‚                  â”‚
    â”‚               â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚               â”‚                 â”‚                      â”‚                  â”‚
    â”‚               â”‚ start()         â”‚                      â”‚                  â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                  â”‚
    â”‚               â”‚                 â”‚                      â”‚                  â”‚
    â”‚               â”‚                 â”‚  adb forward tcp:27183â†’localabstract:scrcpy
    â”‚               â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚               â”‚                 â”‚  adb forward tcp:27184â†’localabstract:scrcpy
    â”‚               â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚               â”‚                 â”‚                      â”‚                  â”‚
    â”‚               â”‚                 â”‚  adb shell CLASSPATH=... app_process ...â”‚
    â”‚               â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚               â”‚                 â”‚                      â”‚    [serverå¯åŠ¨]  â”‚
    â”‚               â”‚                 â”‚                      â”‚                  â”‚
    â”‚               â”‚ connect_video() â”‚                      â”‚                  â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                  â”‚
    â”‚               â”‚                 â”‚  TCP connect 127.0.0.1:27183            â”‚
    â”‚               â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚               â”‚                 â”‚                      â”‚                  â”‚
    â”‚               â”‚ connect_control()                      â”‚                  â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                  â”‚
    â”‚               â”‚                 â”‚  TCP connect 127.0.0.1:27184            â”‚
    â”‚               â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚               â”‚                 â”‚                      â”‚                  â”‚
    â”‚               â”‚ read_video_header()                    â”‚                  â”‚
    â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                  â”‚
    â”‚               â”‚                 â”‚                      â”‚    dummy byte    â”‚
    â”‚               â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚               â”‚                 â”‚                      â”‚                  â”‚
    â”‚               â”‚ [è¿›å…¥ä¸»äº‹ä»¶å¾ªç¯] â”‚                      â”‚                  â”‚
    â”‚               â”‚                 â”‚                      â”‚   H.264 NALæµ    â”‚
    â”‚               â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚               â”‚                 â”‚                      â”‚                  â”‚
```

### 3.2 å¯åŠ¨ä»£ç æµç¨‹

```rust
// src/main.rs - ç®€åŒ–çš„å¯åŠ¨æµç¨‹
#[tokio::main]
async fn main() -> Result<()> {
    // 1. è§£æå‘½ä»¤è¡Œå‚æ•°
    let args = Args::parse();

    // 2. åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
    tracing_subscriber::fmt().with_max_level(log_level).init();

    // 3. åˆ›å»º ADB å®¢æˆ·ç«¯
    let adb = AdbClient::new(args.adb_path);

    // 4. è·å–è®¾å¤‡åˆ—è¡¨å¹¶é€‰æ‹©è®¾å¤‡
    let devices = adb.list_devices().await?;
    let device_id = devices[0].clone();

    // 5. è·å–è®¾å¤‡ç‰©ç†å±å¹•å°ºå¯¸
    let wm_size_output = adb.shell(&device_id, "wm size").await?;
    let (device_width, device_height) = parse_wm_size(&wm_size_output)?;

    // 6. åˆ›å»ºå¹¶é…ç½® ScrcpyServer
    let mut server = ScrcpyServer::with_config(adb, device_id, ...);

    // 7. éƒ¨ç½² server åˆ°è®¾å¤‡
    server.deploy().await?;

    // 8. å¯åŠ¨ server (è®¾ç½®ç«¯å£è½¬å‘å¹¶æ‰§è¡Œ)
    server.start().await?;

    // 9. è¿æ¥è§†é¢‘æµå’Œæ§åˆ¶æµ
    let video_stream = server.connect_video().await?;
    let control_stream = server.connect_control().await?;

    // 10. è¯»å–åè®®å¤´ (dummy byte)
    let codec_info = ScrcpyServer::read_video_header(&mut video_stream).await?;

    // 11. åˆ›å»ºé€šé“
    let (idr_request_tx, idr_request_rx) = mpsc::channel(10);
    let (control_tx, control_rx) = mpsc::channel(100);

    // 12. åˆ›å»ºå¹¶å¯åŠ¨ WebSocket æœåŠ¡å™¨
    let ws_server = WebSocketServer::new(ws_port, idr_request_tx, control_tx, ...);
    tokio::spawn(async move { ws_server.start().await });

    // 13. è¿›å…¥ä¸»äº‹ä»¶å¾ªç¯
    loop {
        tokio::select! {
            Some(control_event) = control_rx.recv() => { /* å¤„ç†æ§åˆ¶äº‹ä»¶ */ }
            Some(_) = idr_request_rx.recv() => { /* å¤„ç†IDRè¯·æ±‚ */ }
            frame_result = reader.read_frame(false) => { /* å¤„ç†è§†é¢‘å¸§ */ }
        }
    }
}
```

---

## 4. ADBé€šä¿¡å±‚

### 4.1 AdbClient å®ç°

```rust
// src/adb/client.rs
pub struct AdbClient {
    pub adb_path: PathBuf,  // ADB å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
}

impl AdbClient {
    /// æ‰§è¡Œ ADB å‘½ä»¤å¹¶è¿”å›è¾“å‡º
    pub async fn execute(&self, args: &[&str]) -> Result<String>;

    /// è·å–å·²è¿æ¥çš„è®¾å¤‡åˆ—è¡¨
    pub async fn list_devices(&self) -> Result<Vec<String>>;

    /// æ¨é€æ–‡ä»¶åˆ°è®¾å¤‡
    pub async fn push(&self, device_id: &str, local: &str, remote: &str) -> Result<()>;

    /// æ‰§è¡Œ shell å‘½ä»¤
    pub async fn shell(&self, device_id: &str, command: &str) -> Result<String>;

    /// è®¾ç½®ç«¯å£è½¬å‘
    pub async fn forward(&self, device_id: &str, local_port: u16, remote: &str) -> Result<()>;

    /// ç§»é™¤ç«¯å£è½¬å‘
    pub async fn forward_remove(&self, device_id: &str, local_port: u16) -> Result<()>;
}
```

### 4.2 å…³é”® ADB å‘½ä»¤

| å‘½ä»¤          | ç”¨é€”            | ç¤ºä¾‹                                                |
| ------------- | --------------- | --------------------------------------------------- |
| `adb devices` | åˆ—å‡ºå·²è¿æ¥è®¾å¤‡  | `adb devices`                                       |
| `adb push`    | æ¨é€æ–‡ä»¶åˆ°è®¾å¤‡  | `adb -s xxx push server.jar /data/local/tmp/`       |
| `adb shell`   | æ‰§è¡Œ shell å‘½ä»¤ | `adb -s xxx shell wm size`                          |
| `adb forward` | ç«¯å£è½¬å‘        | `adb -s xxx forward tcp:27183 localabstract:scrcpy` |

### 4.3 ç«¯å£è½¬å‘æœºåˆ¶

```
PC ç«¯                                    Android è®¾å¤‡ç«¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚                     â”‚                             â”‚
â”‚  127.0.0.1:27183â”œâ”€â”€â”€â”€â”€â”€ USB/WiFi â”€â”€â”€â”€â–ºâ”‚ localabstract:scrcpy        â”‚
â”‚  (è§†é¢‘æµ)       â”‚      ADB Forward    â”‚ (Unix Abstract Socket)       â”‚
â”‚                 â”‚                     â”‚                             â”‚
â”‚  127.0.0.1:27184â”œâ”€â”€â”€â”€â”€â”€ USB/WiFi â”€â”€â”€â”€â–ºâ”‚ localabstract:scrcpy        â”‚
â”‚  (æ§åˆ¶æµ)       â”‚      ADB Forward    â”‚ (åŒä¸€ä¸ªSocket,ä¸åŒè¿æ¥)       â”‚
â”‚                 â”‚                     â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é‡è¦è¯´æ˜**: è§†é¢‘æµå’Œæ§åˆ¶æµä½¿ç”¨åŒä¸€ä¸ª `localabstract:scrcpy` socketï¼Œä½†æ˜¯æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ TCP è¿æ¥ã€‚scrcpy-server ä¼šæ ¹æ®è¿æ¥é¡ºåºåŒºåˆ†ï¼šç¬¬ä¸€ä¸ªè¿æ¥æ˜¯è§†é¢‘æµï¼Œç¬¬äºŒä¸ªè¿æ¥æ˜¯æ§åˆ¶æµã€‚

---

## 5. Scrcpy Serveråè®®

### 5.1 Server å¯åŠ¨å‚æ•°

```bash
CLASSPATH=/data/local/tmp/scrcpy-server.jar \
app_process / com.genymobile.scrcpy.Server 3.3.4 \
    log_level=info \
    max_size=1920 \           # æœ€å¤§åˆ†è¾¨ç‡
    video_bit_rate=4000000 \  # è§†é¢‘ç ç‡ (é»˜è®¤ï¼š4Mbps)
    max_fps=60 \              # æœ€å¤§å¸§ç‡
    video_codec_options=i-frame-interval=1 \  # IDRå¸§é—´éš”(é»˜è®¤ï¼š1ç§’)
    tunnel_forward=true \     # ä½¿ç”¨ç«¯å£è½¬å‘æ¨¡å¼
    send_device_meta=false \  # ä¸å‘é€è®¾å¤‡å…ƒæ•°æ®
    send_frame_meta=false \   # ä¸å‘é€å¸§å…ƒæ•°æ®
    send_dummy_byte=true \    # å‘é€ dummy byte
    send_codec_meta=false \   # ä¸å‘é€ç¼–è§£ç å™¨å…ƒæ•°æ®
    raw_stream=true \         # åŸå§‹ NAL æµæ¨¡å¼
    audio=false \             # ç¦ç”¨éŸ³é¢‘
    control=true \            # å¯ç”¨æ§åˆ¶
    cleanup=true              # é€€å‡ºæ—¶æ¸…ç†
```

### 5.2 raw_stream æ¨¡å¼åè®®

å½“ `raw_stream=true` æ—¶ï¼Œè§†é¢‘æµæ ¼å¼éå¸¸ç®€å•ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Video Stream Format                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚ Dummy    â”‚  1 byte (0x00)                                â”‚
â”‚  â”‚ Byte     â”‚  è¡¨ç¤ºè¿æ¥å»ºç«‹æˆåŠŸ                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Annex-B H.264 NAL Stream                â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ Start Code â”‚         NAL Unit Data           â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ 00 00 01   â”‚  [NAL Header][RBSP Payload]     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                        â”‚                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ Start Code â”‚         NAL Unit Data           â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ 00 00 00 01â”‚  [NAL Header][RBSP Payload]     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                        â”‚                             â”‚   â”‚
â”‚  â”‚                       ...                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 åŒè¿æ¥æ¨¡å¼

scrcpy 3.x åœ¨ `control=true` æ¨¡å¼ä¸‹éœ€è¦ä¸¤ä¸ªè¿æ¥ï¼š

```
è¿æ¥é¡ºåº:
1. ç¬¬ä¸€ä¸ª TCP è¿æ¥ â†’ è§†é¢‘æµ (Video Socket)
2. ç¬¬äºŒä¸ª TCP è¿æ¥ â†’ æ§åˆ¶æµ (Control Socket)

é‡è¦: Server ä¼šç­‰å¾…ä¸¤ä¸ªè¿æ¥éƒ½å»ºç«‹åæ‰å¼€å§‹å‘é€æ•°æ®ï¼
```

---

## 6. è§†é¢‘æµå¤„ç†

### 6.1 H.264 NAL å•å…ƒç±»å‹

| NAL Type | åç§°          | è¯´æ˜                |
| -------- | ------------- | ------------------- |
| 1        | Non-IDR Slice | P/B å¸§ (éœ€è¦å‚è€ƒå¸§) |
| 5        | IDR Slice     | å…³é”®å¸§ (ç‹¬ç«‹è§£ç )   |
| 6        | SEI           | è¡¥å……å¢å¼ºä¿¡æ¯        |
| 7        | SPS           | åºåˆ—å‚æ•°é›†          |
| 8        | PPS           | å›¾åƒå‚æ•°é›†          |

### 6.2 VideoStreamReader å®ç°

```rust
// src/scrcpy/video.rs
pub struct VideoStreamReader {
    stream: TcpStream,
    buffer: BytesMut,          // 1MB è¯»å–ç¼“å†²åŒº
    frame_count: u64,
    first_start_code_pos: Option<usize>,  // ç¬¬ä¸€ä¸ªèµ·å§‹ç ä½ç½®
}

impl VideoStreamReader {
    /// è¯»å–ä¸‹ä¸€ä¸ª NAL å•å…ƒ
    ///
    /// è§£æé€»è¾‘:
    /// 1. é€å­—èŠ‚è¯»å–æ•°æ®åˆ°ç¼“å†²åŒº
    /// 2. æ£€æµ‹ 00 00 01 èµ·å§‹ç 
    /// 3. ç¬¬ä¸€ä¸ªèµ·å§‹ç æ ‡è®° NAL å¼€å§‹
    /// 4. ç¬¬äºŒä¸ªèµ·å§‹ç æ ‡è®° NAL ç»“æŸ
    /// 5. æå–ä¸­é—´çš„ NAL æ•°æ®å¹¶è¿”å›
    pub async fn read_frame(&mut self, _with_meta: bool) -> Result<Option<VideoFrame>> {
        loop {
            // é€å­—èŠ‚è¯»å–
            let mut byte = [0u8; 1];
            self.stream.read_exact(&mut byte).await?;
            self.buffer.extend_from_slice(&byte);

            // æ£€æŸ¥ 3-byte èµ·å§‹ç  00 00 01
            let buf_len = self.buffer.len();
            if buf_len >= 3 {
                let last_3 = &self.buffer[buf_len - 3..];

                if last_3 == [0x00, 0x00, 0x01] {
                    if self.first_start_code_pos.is_none() {
                        // è®°å½•ç¬¬ä¸€ä¸ªèµ·å§‹ç ä½ç½®
                        self.first_start_code_pos = Some(buf_len - 3);
                    } else {
                        // æå– NAL å•å…ƒ
                        let start = self.first_start_code_pos.unwrap() + 3;
                        let end = buf_len - 3;
                        let nal_data = self.buffer[start..end].to_vec();

                        // è§£æ NAL ç±»å‹
                        let nal_type = nal_data[0] & 0x1F;
                        let frame_type = match nal_type {
                            7 | 8 => FrameType::Config,  // SPS/PPS
                            _ => FrameType::Video,
                        };

                        return Ok(Some(VideoFrame::new(0, frame_type, Bytes::from(nal_data))));
                    }
                }
            }
        }
    }
}
```

### 6.3 NAL å•å…ƒè§£ææµç¨‹å›¾

```
è¾“å…¥æ•°æ®æµ:
... 00 00 01 [SPSæ•°æ®] 00 00 01 [PPSæ•°æ®] 00 00 01 [IDRæ•°æ®] 00 00 01 ...
    â†‘        â†‘         â†‘        â†‘         â†‘        â†‘         â†‘
    â”‚        â”‚         â”‚        â”‚         â”‚        â”‚         â”‚
    â”‚        â”‚         â”‚        â”‚         â”‚        â”‚         â”‚
    èµ·å§‹ç 1   NAL1ç»“æŸ   èµ·å§‹ç 2   NAL2ç»“æŸ   èµ·å§‹ç 3   NAL3ç»“æŸ   èµ·å§‹ç 4
             NAL1æå–            NAL2æå–            NAL3æå–

è§£æçŠ¶æ€æœº:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    æ£€æµ‹åˆ° 00 00 01    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç­‰å¾…ç¬¬ä¸€ä¸ª  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  ç­‰å¾…ç¬¬äºŒä¸ª  â”‚
â”‚   èµ·å§‹ç     â”‚                       â”‚   èµ·å§‹ç      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â”‚ æ£€æµ‹åˆ° 00 00 01
                                             â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚  æå–NAL     â”‚
                                      â”‚  è¿”å›å¸§      â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â”‚ å¾ªç¯
                                             â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚  ç­‰å¾…ä¸‹ä¸€ä¸ª  â”‚
                                      â”‚   èµ·å§‹ç     â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.4 SPS è§£æè·å–åˆ†è¾¨ç‡

```rust
// src/main.rs - SPS è§£æå™¨
struct BitReader<'a> {
    data: &'a [u8],
    byte_offset: usize,
    bit_offset: u8,
}

impl BitReader {
    /// è¯»å– Exp-Golomb ç¼–ç çš„æ— ç¬¦å·æ•´æ•° (ue(v))
    fn read_ue(&mut self) -> Option<u32>;

    /// è¯»å– Exp-Golomb ç¼–ç çš„æœ‰ç¬¦å·æ•´æ•° (se(v))
    fn read_se(&mut self) -> Option<i32>;
}

fn parse_sps_resolution(sps_data: &[u8]) -> Option<(u32, u32)> {
    // SPS ç»“æ„ (ç®€åŒ–):
    // - NAL header (1 byte)
    // - profile_idc (8 bits)
    // - constraint_flags (8 bits)
    // - level_idc (8 bits)
    // - seq_parameter_set_id (ue(v))
    // - [High Profile specific data]
    // - log2_max_frame_num_minus4 (ue(v))
    // - pic_order_cnt_type (ue(v))
    // - ...
    // - pic_width_in_mbs_minus1 (ue(v))      â† å®½åº¦
    // - pic_height_in_map_units_minus1 (ue(v)) â† é«˜åº¦
    // - frame_mbs_only_flag (1 bit)
    // - frame_cropping_flag (1 bit)
    // - [cropping offsets]

    // è®¡ç®—åˆ†è¾¨ç‡:
    // width = (pic_width_in_mbs_minus1 + 1) * 16 - crop_left - crop_right
    // height = (pic_height_in_map_units_minus1 + 1) * 16 * (2 - frame_mbs_only_flag)
    //          - crop_top - crop_bottom
}
```

---

## 7. æ§åˆ¶æµå¤„ç†

### 7.1 æ§åˆ¶æ¶ˆæ¯ç±»å‹

```rust
// src/scrcpy/control.rs
#[repr(u8)]
pub enum ControlMessageType {
    InjectKeycode = 0,            // æŒ‰é”®äº‹ä»¶
    InjectText = 1,               // æ–‡æœ¬è¾“å…¥
    InjectTouch = 2,              // è§¦æ‘¸äº‹ä»¶
    InjectScroll = 3,             // æ»šåŠ¨äº‹ä»¶
    SetScreenPowerMode = 4,       // å±å¹•ç”µæºæ§åˆ¶
    ExpandNotificationPanel = 5,  // å±•å¼€é€šçŸ¥æ 
    CollapseNotificationPanel = 6,// æ”¶èµ·é€šçŸ¥æ 
    GetClipboard = 7,             // è·å–å‰ªè´´æ¿
    SetClipboard = 8,             // è®¾ç½®å‰ªè´´æ¿
    RotateDevice = 10,            // æ—‹è½¬è®¾å¤‡
    // ... æ›´å¤šç±»å‹å¯ä»¥ç¿»ç¿»æºç 
}
```

### 7.2 è§¦æ‘¸äº‹ä»¶åè®® (32 å­—èŠ‚)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Touch Event Message Format (32 bytes)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Offset â”‚ Size â”‚ Field         â”‚ Type      â”‚ Description                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚    0    â”‚  1   â”‚ type          â”‚ u8        â”‚ = 2 (InjectTouch)          â”‚
â”‚    1    â”‚  1   â”‚ action        â”‚ u8        â”‚ 0=Down, 1=Up, 2=Move       â”‚
â”‚    2    â”‚  8   â”‚ pointer_id    â”‚ i64 BE    â”‚ -1=é¼ æ ‡, >=0=è§¦æ‘¸           â”‚
â”‚   10    â”‚  4   â”‚ x             â”‚ u32 BE    â”‚ åƒç´ åæ ‡                    â”‚
â”‚   14    â”‚  4   â”‚ y             â”‚ u32 BE    â”‚ åƒç´ åæ ‡                    â”‚
â”‚   18    â”‚  2   â”‚ width         â”‚ u16 BE    â”‚ å±å¹•å®½åº¦                    â”‚
â”‚   20    â”‚  2   â”‚ height        â”‚ u16 BE    â”‚ å±å¹•é«˜åº¦                    â”‚
â”‚   22    â”‚  2   â”‚ pressure      â”‚ u16 BE    â”‚ 0x0000-0xFFFF (0.0-1.0)    â”‚
â”‚   24    â”‚  4   â”‚ action_button â”‚ u32 BE    â”‚ é¼ æ ‡=1, è§¦æ‘¸=0              â”‚
â”‚   28    â”‚  4   â”‚ buttons       â”‚ u32 BE    â”‚ æŒ‰é’®çŠ¶æ€                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                         â”‚
â”‚  ç¤ºä¾‹ (é¼ æ ‡ç‚¹å‡» DOWN):                                                   â”‚
â”‚  [02, 00, ff, ff, ff, ff, ff, ff, ff, ff,    â† type=2, action=0, id=-1  â”‚
â”‚   00, 00, 01, 2c, 00, 00, 02, 58,            â† x=300, y=600             â”‚
â”‚   04, 38, 07, 80,                            â† width=1080, height=1920  â”‚
â”‚   ff, ff,                                    â† pressure=1.0             â”‚
â”‚   00, 00, 00, 01,                            â† action_button=1          â”‚
â”‚   00, 00, 00, 01]                            â† buttons=1                â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 è§¦æ‘¸åŠ¨ä½œæšä¸¾

```rust
#[repr(u8)]
pub enum AndroidMotionEventAction {
    Down = 0,        // ACTION_DOWN - ç¬¬ä¸€ä¸ªæ‰‹æŒ‡æŒ‰ä¸‹
    Up = 1,          // ACTION_UP - æœ€åä¸€ä¸ªæ‰‹æŒ‡æŠ¬èµ·
    Move = 2,        // ACTION_MOVE - æ‰‹æŒ‡ç§»åŠ¨
    Cancel = 3,      // ACTION_CANCEL - äº‹ä»¶å–æ¶ˆ
    PointerDown = 5, // ACTION_POINTER_DOWN - éç¬¬ä¸€ä¸ªæ‰‹æŒ‡æŒ‰ä¸‹
    PointerUp = 6,   // ACTION_POINTER_UP - éæœ€åä¸€ä¸ªæ‰‹æŒ‡æŠ¬èµ·
    HoverMove = 7,   // ACTION_HOVER_MOVE - é¼ æ ‡æ‚¬åœç§»åŠ¨
    HoverEnter = 9,  // ACTION_HOVER_ENTER - é¼ æ ‡è¿›å…¥
    HoverExit = 10,  // ACTION_HOVER_EXIT - é¼ æ ‡ç¦»å¼€
}
```

### 7.4 æŒ‰é”®äº‹ä»¶åè®® (14 å­—èŠ‚)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Key Event Message Format (14 bytes)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Offset â”‚ Size â”‚ Field     â”‚ Type    â”‚ Description                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚    0    â”‚  1   â”‚ type      â”‚ u8      â”‚ = 0 (InjectKeycode)              â”‚
â”‚    1    â”‚  1   â”‚ action    â”‚ u8      â”‚ 0=Down, 1=Up                     â”‚
â”‚    2    â”‚  4   â”‚ keycode   â”‚ u32 BE  â”‚ Android KeyCode                  â”‚
â”‚    6    â”‚  4   â”‚ repeat    â”‚ u32 BE  â”‚ é‡å¤æ¬¡æ•°                          â”‚
â”‚   10    â”‚  4   â”‚ metastate â”‚ u32 BE  â”‚ ä¿®é¥°é”®çŠ¶æ€ (Shift/Ctrl/Alt)       â”‚
â”‚                                                                         â”‚
â”‚  å¸¸ç”¨ Android KeyCode:                                                  â”‚
â”‚    KEYCODE_BACK = 4       â† è¿”å›é”®                                      â”‚
â”‚    KEYCODE_HOME = 3       â† Homeé”®                                      â”‚
â”‚    KEYCODE_VOLUME_UP = 24                                               â”‚
â”‚    KEYCODE_VOLUME_DOWN = 25                                             â”‚
â”‚    KEYCODE_POWER = 26                                                   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.5 æ»šåŠ¨äº‹ä»¶åè®® (25 å­—èŠ‚)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Scroll Event Message Format (25 bytes)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Offset â”‚ Size â”‚ Field   â”‚ Type    â”‚ Description                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚    0    â”‚  1   â”‚ type    â”‚ u8      â”‚ = 3 (InjectScroll)                 â”‚
â”‚    1    â”‚  4   â”‚ x       â”‚ u32 BE  â”‚ åƒç´ åæ ‡                            â”‚
â”‚    5    â”‚  4   â”‚ y       â”‚ u32 BE  â”‚ åƒç´ åæ ‡                            â”‚
â”‚    9    â”‚  2   â”‚ width   â”‚ u16 BE  â”‚ å±å¹•å®½åº¦                            â”‚
â”‚   11    â”‚  2   â”‚ height  â”‚ u16 BE  â”‚ å±å¹•é«˜åº¦                            â”‚
â”‚   13    â”‚  4   â”‚ hscroll â”‚ i32 BE  â”‚ æ°´å¹³æ»šåŠ¨é‡                          â”‚
â”‚   17    â”‚  4   â”‚ vscroll â”‚ i32 BE  â”‚ å‚ç›´æ»šåŠ¨é‡                          â”‚
â”‚   21    â”‚  4   â”‚ buttons â”‚ u32 BE  â”‚ æŒ‰é’®çŠ¶æ€                            â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.6 ControlChannel å®ç°

```rust
// src/scrcpy/control.rs
pub struct ControlChannel {
    stream: TcpStream,  // TCP è¿æ¥åˆ° scrcpy-server
}

impl ControlChannel {
    /// å‘é€è§¦æ‘¸äº‹ä»¶
    pub async fn send_touch_event(&mut self, event: &TouchEvent) -> Result<()> {
        let mut msg = Vec::with_capacity(32);

        // æ„å»ºæ¶ˆæ¯ (æ‰€æœ‰å¤šå­—èŠ‚å­—æ®µä½¿ç”¨å¤§ç«¯åº)
        msg.push(ControlMessageType::InjectTouch as u8);  // type
        msg.push(event.action as u8);                      // action
        msg.extend_from_slice(&event.pointer_id.to_be_bytes());  // pointer_id (i64)

        // è®¡ç®—åƒç´ åæ ‡ (å½’ä¸€åŒ–åæ ‡ Ã— å±å¹•å°ºå¯¸)
        let x_fixed = (event.x * event.width as f32) as u32;
        let y_fixed = (event.y * event.height as f32) as u32;
        msg.extend_from_slice(&x_fixed.to_be_bytes());
        msg.extend_from_slice(&y_fixed.to_be_bytes());

        msg.extend_from_slice(&(event.width as u16).to_be_bytes());
        msg.extend_from_slice(&(event.height as u16).to_be_bytes());

        // pressure: 16ä½å®šç‚¹æ•° (0.0 â†’ 0x0000, 1.0 â†’ 0xFFFF)
        let pressure_u16 = (event.pressure * 0xFFFF as f32) as u16;
        msg.extend_from_slice(&pressure_u16.to_be_bytes());

        // action_button å’Œ buttons çš„ç‰¹æ®Šå¤„ç†
        let action_button = if event.pointer_id == -1 { 1u32 } else { 0u32 };
        let buttons = match event.action {
            Up | PointerUp => 0u32,
            _ => event.buttons,
        };
        msg.extend_from_slice(&action_button.to_be_bytes());
        msg.extend_from_slice(&buttons.to_be_bytes());

        // å‘é€å¹¶åˆ·æ–°
        self.stream.write_all(&msg).await?;
        self.stream.flush().await?;

        Ok(())
    }
}
```

---

## 8. WebSocketé€šä¿¡

### 8.1 WebSocket æœåŠ¡å™¨æ¶æ„

```rust
// src/ws/server.rs
pub struct WebSocketServer {
    addr: SocketAddr,
    tx: broadcast::Sender<Bytes>,           // è§†é¢‘å¸§å¹¿æ’­é€šé“
    video_config: Arc<RwLock<VideoConfig>>, // SPS/PPS ç¼“å­˜
    idr_request_tx: mpsc::Sender<()>,       // IDR è¯·æ±‚é€šé“
    control_tx: mpsc::Sender<TouchEvent>,   // æ§åˆ¶äº‹ä»¶é€šé“
}

pub struct VideoConfig {
    pub sps: Option<Bytes>,       // ç¼“å­˜çš„ SPS
    pub pps: Option<Bytes>,       // ç¼“å­˜çš„ PPS
    pub width: u32,               // è§†é¢‘æµåˆ†è¾¨ç‡
    pub height: u32,
    pub device_width: u32,        // è®¾å¤‡ç‰©ç†åˆ†è¾¨ç‡ (ç”¨äºè§¦æ§)
    pub device_height: u32,
}
```

### 8.2 WebSocket æ¶ˆæ¯åè®®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     WebSocket Message Protocol                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯:                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚                                                                         â”‚
â”‚  1. é…ç½®æ¶ˆæ¯ (Text/JSON):                                                â”‚
â”‚     {                                                                   â”‚
â”‚       "type": "config",                                                 â”‚
â”‚       "width": 1920,          â† è§†é¢‘æµåˆ†è¾¨ç‡ (ç”¨äºcanvas)                â”‚
â”‚       "height": 1080,                                                   â”‚
â”‚       "device_width": 1080,   â† è®¾å¤‡ç‰©ç†åˆ†è¾¨ç‡ (ç”¨äºè§¦æ§)                 â”‚
â”‚       "device_height": 1920                                             â”‚
â”‚     }                                                                   â”‚
â”‚                                                                         â”‚
â”‚  2. è§†é¢‘å¸§ (Binary):                                                    â”‚
â”‚     [00 00 00 01] [NAL Unit Data]                                       â”‚
â”‚     â””â”€â”€èµ·å§‹ç â”€â”€â”˜  â””â”€â”€H.264 æ•°æ®â”€â”€â”˜                                       â”‚
â”‚                                                                         â”‚
â”‚                                                                         â”‚
â”‚  å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨:                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚                                                                         â”‚
â”‚  1. è§¦æ§äº‹ä»¶ (Text/JSON):                                                â”‚
â”‚     {                                                                   â”‚
â”‚       "action": 0,            â† 0=Down, 1=Up, 2=Move                    â”‚
â”‚       "pointer_id": -1,       â† -1=é¼ æ ‡, >=0=è§¦æ‘¸                        â”‚
â”‚       "x": 0.5,               â† å½’ä¸€åŒ–åæ ‡ [0, 1]                        â”‚
â”‚       "y": 0.3,               â† å½’ä¸€åŒ–åæ ‡ [0, 1]                        â”‚
â”‚       "pressure": 1.0,        â† å‹åŠ› [0, 1]                             â”‚
â”‚       "width": 1920,          â† è§†é¢‘æµå®½åº¦                               â”‚
â”‚       "height": 1080,         â† è§†é¢‘æµé«˜åº¦                               â”‚
â”‚       "buttons": 1            â† æŒ‰é’®çŠ¶æ€                                 â”‚
â”‚     }                                                                   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 å®¢æˆ·ç«¯è¿æ¥å¤„ç†æµç¨‹

```rust
async fn handle_client(
    mut socket: WebSocket,
    tx: broadcast::Sender<Bytes>,
    video_config: Arc<RwLock<VideoConfig>>,
    idr_request_tx: mpsc::Sender<()>,
    control_tx: mpsc::Sender<TouchEvent>,
) {
    // 1. è¯·æ±‚ IDR å¸§ (ç¡®ä¿æ–°å®¢æˆ·ç«¯èƒ½ç«‹å³è§£ç )
    idr_request_tx.send(()).await;

    // 2. å‘é€é…ç½®ä¿¡æ¯
    let config = video_config.read().await;
    let config_msg = format!(r#"{{"type":"config","width":{},"height":{},...}}"#, ...);
    socket.send(Message::Text(config_msg)).await;

    // 3. å‘é€ç¼“å­˜çš„ SPS/PPS
    if let Some(sps) = &config.sps {
        socket.send(Message::Binary(sps.to_vec())).await;
    }
    if let Some(pps) = &config.pps {
        socket.send(Message::Binary(pps.to_vec())).await;
    }

    // 4. è®¢é˜…è§†é¢‘å¸§å¹¿æ’­
    let mut rx = tx.subscribe();

    // 5. ä¸»å¾ªç¯: è½¬å‘è§†é¢‘å¸§ + å¤„ç†æ§åˆ¶äº‹ä»¶
    loop {
        tokio::select! {
            // æ¥æ”¶è§†é¢‘å¸§å¹¶è½¬å‘
            frame_result = rx.recv() => {
                match frame_result {
                    Ok(frame) => socket.send(Message::Binary(frame.to_vec())).await,
                    Err(Lagged(_)) => {
                        // è¿½å¸§: ä¸¢å¼ƒç§¯å‹çš„æ—§å¸§,è·³åˆ°æœ€æ–°
                        while let Ok(latest) = rx.try_recv() {
                            socket.send(Message::Binary(latest.to_vec())).await;
                        }
                    }
                }
            }

            // æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯
            msg = socket.recv() => {
                match msg {
                    Some(Ok(Message::Text(text))) => {
                        // è§£æè§¦æ§äº‹ä»¶å¹¶è½¬å‘
                        let touch_event: TouchEvent = serde_json::from_str(&text)?;
                        control_tx.send(touch_event).await;
                    }
                    Some(Ok(Message::Close(_))) => break,
                }
            }
        }
    }
}
```

### 8.4 è¿½å¸§ç­–ç•¥

```
å½“å®¢æˆ·ç«¯å¤„ç†é€Ÿåº¦æ…¢äºè§†é¢‘å¸§ç‡æ—¶,å¹¿æ’­é€šé“ä¼šç§¯å‹å¸§:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         è¿½å¸§ (Frame Catching Up)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  å¹¿æ’­é€šé“:  [å¸§1] [å¸§2] [å¸§3] [å¸§4] [å¸§5] [å¸§6] ... [å¸§N]                 â”‚
â”‚              â†‘                                        â†‘                 â”‚
â”‚              â”‚                                        â”‚                 â”‚
â”‚           å®¢æˆ·ç«¯ä½ç½®                               æœ€æ–°å¸§                â”‚
â”‚           (æ»å)                                                        â”‚
â”‚                                                                         â”‚
â”‚  å½“æ£€æµ‹åˆ° RecvError::Lagged æ—¶:                                          â”‚
â”‚                                                                         â”‚
â”‚  1. è¿›å…¥è¿½å¸§æ¨¡å¼                                                         â”‚
â”‚  2. ä½¿ç”¨ try_recv() å¿«é€Ÿæ¶ˆè´¹æ‰€æœ‰ç§¯å‹å¸§                                    â”‚
â”‚  3. åªå‘é€æœ€æ–°çš„å‡ å¸§ç»™å®¢æˆ·ç«¯                                              â”‚
â”‚  4. è·³è¿‡ä¸­é—´çš„æ—§å¸§ä»¥å‡å°‘å»¶è¿Ÿ                                              â”‚
â”‚                                                                         â”‚
â”‚  æ•ˆæœ: ç‰ºç‰²æµç•…æ€§æ¢å–ä½å»¶è¿Ÿ                                               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. å‰ç«¯è§£ç ä¸æ¸²æŸ“

### 9.1 WebCodecs è§£ç æµç¨‹

```javascript
// åˆå§‹åŒ–è§£ç å™¨
decoder = new VideoDecoder({
    output: (frame) => {
        // ç»˜åˆ¶åˆ° canvas
        ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);
        frame.close();
    },
    error: (e) => console.error('Decoder error:', e)
});

// é…ç½®è§£ç å™¨
decoder.configure({
    codec: 'avc1.42001E',          // H.264 Baseline Profile Level 3.0
    optimizeForLatency: true,       // ä¼˜åŒ–å»¶è¿Ÿ
    hardwareAcceleration: 'prefer-hardware',  // ä¼˜å…ˆç¡¬ä»¶åŠ é€Ÿ
});
```

### 9.2 NAL å•å…ƒå¤„ç†é€»è¾‘

```javascript
ws.onmessage = (event) => {
    if (event.data instanceof ArrayBuffer) {
        const data = new Uint8Array(event.data);

        // è§£æ NAL ç±»å‹ (è·³è¿‡ 00 00 00 01 èµ·å§‹ç )
        const nalType = data[4] & 0x1F;

        switch (nalType) {
            case 7:  // SPS
                cachedSPS = data;
                return;  // ä¸ç«‹å³è§£ç ,ç­‰å¾… IDR

            case 8:  // PPS
                cachedPPS = data;
                return;  // ä¸ç«‹å³è§£ç ,ç­‰å¾… IDR

            case 5:  // IDR (å…³é”®å¸§)
                // åˆå¹¶ SPS + PPS + IDR
                const combined = new Uint8Array(
                    cachedSPS.length + cachedPPS.length + data.length
                );
                combined.set(cachedSPS, 0);
                combined.set(cachedPPS, cachedSPS.length);
                combined.set(data, cachedSPS.length + cachedPPS.length);

                // ä½œä¸ºå…³é”®å¸§è§£ç 
                decoder.decode(new EncodedVideoChunk({
                    type: 'key',
                    timestamp: performance.now() * 1000,
                    data: combined
                }));
                break;

            default:  // P/B å¸§
                // é™åˆ¶è§£ç å™¨é˜Ÿåˆ—,é˜²æ­¢ç§¯å‹
                if (decoder.decodeQueueSize > 3) {
                    console.warn('Dropping P-frame');
                    return;
                }

                decoder.decode(new EncodedVideoChunk({
                    type: 'delta',
                    timestamp: performance.now() * 1000,
                    data: data
                }));
        }
    }
};
```

### 9.3 è§¦æ§äº‹ä»¶å¤„ç†

```javascript
// åæ ‡è½¬æ¢: Canvasåƒç´  â†’ å½’ä¸€åŒ–åæ ‡ [0, 1]
function normalizeCoords(canvasX, canvasY) {
    const rect = canvas.getBoundingClientRect();
    const x = (canvasX - rect.left) / rect.width;
    const y = (canvasY - rect.top) / rect.height;
    return {
        x: Math.max(0, Math.min(1, x)),
        y: Math.max(0, Math.min(1, y))
    };
}

// å‘é€è§¦æ§äº‹ä»¶
function sendTouchEvent(action, pointerId, x, y, pressure = 1.0) {
    const event = {
        action: action,           // 0=Down, 1=Up, 2=Move
        pointer_id: pointerId,    // -1=é¼ æ ‡, >=0=è§¦æ‘¸
        x: x,                     // å½’ä¸€åŒ–åæ ‡
        y: y,
        pressure: pressure,
        width: videoWidth,        // è§†é¢‘æµåˆ†è¾¨ç‡
        height: videoHeight,
        buttons: action === 1 ? 0 : 1  // UPæ—¶buttons=0
    };

    ws.send(JSON.stringify(event));
}

// é¼ æ ‡äº‹ä»¶ (PC)
canvas.addEventListener('mousedown', (e) => {
    const coords = normalizeCoords(e.clientX, e.clientY);
    sendTouchEvent(0, -1, coords.x, coords.y);  // ACTION_DOWN, MOUSE_ID=-1
});

// è§¦æ‘¸äº‹ä»¶ (ç§»åŠ¨ç«¯)
canvas.addEventListener('touchstart', (e) => {
    for (let touch of e.changedTouches) {
        const coords = normalizeCoords(touch.clientX, touch.clientY);
        sendTouchEvent(0, touch.identifier, coords.x, coords.y, touch.force || 1.0);
    }
});
```

---

## 10. æ•°æ®æµè½¬å›¾

### 10.1 è§†é¢‘æµæ•°æ®æµè½¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           è§†é¢‘æµæ•°æ®æµè½¬                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Android è®¾å¤‡                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Surface â†’ MediaCodec (H.264 ç¼–ç ) â†’ NAL Units                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚                                  â”‚
â”‚                                     â”‚ Annex-B NAL Stream               â”‚
â”‚                                     â”‚ (00 00 00 01 + NAL Data)         â”‚
â”‚                                     â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  scrcpy-server â†’ localabstract:scrcpy                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚                                  â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  ADB Forward (USB/WiFi)             â”‚                                  â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                     â”‚                                  â”‚
â”‚  PC ç«¯                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  TCP:27183 â†’ VideoStreamReader                                  â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  é€å­—èŠ‚è¯»å– â†’ æ£€æµ‹èµ·å§‹ç  â†’ æå–NALå•å…ƒ â†’ VideoFrame         â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                     â”‚
â”‚                                  â”‚ VideoFrame { pts, frame_type, data }â”‚
â”‚                                  â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Main Event Loop                                                â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  if SPS/PPS â†’ ç¼“å­˜åˆ° video_config                               â”‚   â”‚
â”‚  â”‚  æ·»åŠ èµ·å§‹ç  [00 00 00 01] + NAL Data                             â”‚   â”‚
â”‚  â”‚  â†’ broadcast::Sender<Bytes>                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                     â”‚
â”‚                                  â”‚ Bytes (å¸¦èµ·å§‹ç çš„NAL)                â”‚
â”‚                                  â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  WebSocketServer                                                â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  broadcast::Receiver â†’ Message::Binary                          â”‚   â”‚
â”‚  â”‚  â†’ WebSocket å‘é€åˆ°æ‰€æœ‰å®¢æˆ·ç«¯                                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                     â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  WebSocket (ws://)               â”‚                                     â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                  â”‚                                     â”‚
â”‚  æµè§ˆå™¨                           â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  JavaScript WebCodecs                                           â”‚   â”‚
â”‚  â”‚                                                                 â”‚   â”‚
â”‚  â”‚  ArrayBuffer â†’ è§£æNALç±»å‹ â†’ ç¼“å­˜SPS/PPS                         â”‚   â”‚
â”‚  â”‚  â†’ IDRæ—¶åˆå¹¶(SPS+PPS+IDR) â†’ EncodedVideoChunk                   â”‚   â”‚
â”‚  â”‚  â†’ VideoDecoder.decode()                                        â”‚   â”‚
â”‚  â”‚  â†’ VideoFrame â†’ Canvas.drawImage()                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 æ§åˆ¶æµæ•°æ®æµè½¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ§åˆ¶æµæ•°æ®æµè½¬                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  æµè§ˆå™¨                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç”¨æˆ·æ“ä½œ (ç‚¹å‡»/æ»‘åŠ¨)                                             â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â–¼                                                              â”‚   â”‚
â”‚  â”‚  normalizeCoords() â†’ å½’ä¸€åŒ–åæ ‡ [0,1]                            â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â–¼                                                              â”‚   â”‚
â”‚  â”‚  JSON.stringify({action, pointer_id, x, y, pressure, ...})      â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â–¼                                                              â”‚   â”‚
â”‚  â”‚  WebSocket.send(text)                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                     â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  WebSocket (ws://)               â”‚  JSON Text                          â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                  â”‚                                     â”‚
â”‚  PC ç«¯                           â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  WebSocketServer::handle_client()                               â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â–¼                                                              â”‚   â”‚
â”‚  â”‚  Message::Text(json) â†’ serde_json::from_str::<TouchEvent>()     â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â–¼                                                              â”‚   â”‚
â”‚  â”‚  control_tx.send(touch_event)                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                      â”‚
â”‚                                  â”‚ mpsc::Sender<TouchEvent>             â”‚
â”‚                                  â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Main Event Loop                                                â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â–¼                                                              â”‚   â”‚
â”‚  â”‚  control_rx.recv() â†’ TouchEvent                                 â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â–¼                                                              â”‚   â”‚
â”‚  â”‚  control_channel.send_touch_event(&event)                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                      â”‚
â”‚                                  â”‚ TouchEvent                           â”‚
â”‚                                  â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ControlChannel::send_touch_event()                             â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â–¼                                                              â”‚   â”‚
â”‚  â”‚  æ„å»º 32 å­—èŠ‚äºŒè¿›åˆ¶æ¶ˆæ¯ (Big Endian)                              â”‚   â”‚
â”‚  â”‚  [type][action][pointer_id][x][y][w][h][pressure][ab][buttons]  â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â–¼                                                              â”‚   â”‚
â”‚  â”‚  TCP write_all() + flush()                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                     â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  ADB Forward TCP:27184           â”‚  Binary (32 bytes)                  â”‚
â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                  â”‚                                     â”‚
â”‚  Android è®¾å¤‡                    â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  scrcpy-server                                                  â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â–¼                                                              â”‚   â”‚
â”‚  â”‚  è§£ææ§åˆ¶æ¶ˆæ¯ â†’ InputManager.injectInputEvent()                  â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â–¼                                                              â”‚   â”‚
â”‚  â”‚  Android ç³»ç»Ÿè§¦æ‘¸äº‹ä»¶ â†’ åº”ç”¨å“åº”                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. å…³é”®æŠ€æœ¯ç»†èŠ‚

### 11.1 å­—èŠ‚åºå¤„ç†

scrcpy åè®®ä½¿ç”¨ **å¤§ç«¯åº (Big Endian)**ï¼š

```rust
// Rust ä¸­çš„å¤§ç«¯åºè½¬æ¢
let x: u32 = 300;
let bytes = x.to_be_bytes();  // [0x00, 0x00, 0x01, 0x2C]

let pointer_id: i64 = -1;
let bytes = pointer_id.to_be_bytes();  // [0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF]
```

### 11.2 å‹åŠ›å€¼ç¼–ç 

å‹åŠ›ä½¿ç”¨ 16 ä½å®šç‚¹æ•°ï¼š

```rust
// float [0.0, 1.0] â†’ u16 [0x0000, 0xFFFF]
let pressure: f32 = 1.0;
let pressure_u16 = (pressure * 0xFFFF as f32) as u16;  // 0xFFFF

let pressure: f32 = 0.0;
let pressure_u16 = (pressure * 0xFFFF as f32) as u16;  // 0x0000

let pressure: f32 = 0.5;
let pressure_u16 = (pressure * 0xFFFF as f32) as u16;  // 0x7FFF
```

### 11.3 åæ ‡ç³»è½¬æ¢

```
æµè§ˆå™¨åæ ‡ â†’ å½’ä¸€åŒ–åæ ‡ â†’ åƒç´ åæ ‡

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµè§ˆå™¨ Canvas                    å½’ä¸€åŒ–                 Android è®¾å¤‡    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              â”‚                â”‚        â”‚            â”‚            â”‚   â”‚
â”‚  â”‚   (300,200)  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â–º     â”‚(0.3,0.2)â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ (324,384)  â”‚   â”‚
â”‚  â”‚    â—         â”‚  /rect.w,h     â”‚   â—    â”‚  *dev_w,h  â”‚    â—       â”‚   â”‚
â”‚  â”‚              â”‚                â”‚        â”‚            â”‚            â”‚   â”‚
â”‚  â”‚  1000x1000   â”‚                â”‚ [0,1]  â”‚            â”‚ 1080x1920  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  è®¡ç®—è¿‡ç¨‹:                                                               â”‚
â”‚  x_norm = (clientX - rect.left) / rect.width = 300/1000 = 0.3           â”‚
â”‚  y_norm = (clientY - rect.top) / rect.height = 200/1000 = 0.2           â”‚
â”‚  x_pixel = x_norm * video_width = 0.3 * 1080 = 324                      â”‚
â”‚  y_pixel = y_norm * video_height = 0.2 * 1920 = 384                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.4 IDR å¸§è¯·æ±‚æœºåˆ¶

```
æ–°å®¢æˆ·ç«¯è¿æ¥æ—¶çš„ IDR å¸§è·å–æµç¨‹:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser     â”‚     â”‚  WS Server   â”‚     â”‚  Main Loop   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚
       â”‚  WS Connect        â”‚                    â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
       â”‚                    â”‚  idr_request_tx    â”‚
       â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                    â”‚                    â”‚
       â”‚  config JSON       â”‚                    â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
       â”‚                    â”‚                    â”‚
       â”‚  cached SPS/PPS    â”‚                    â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
       â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚ è®¾ç½® pending_idr = true
       â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚ ç­‰å¾…ä¸‹ä¸€ä¸ª IDR å¸§
       â”‚                    â”‚                    â”‚ (é€šå¸¸åœ¨ 1 ç§’å†…åˆ°è¾¾)
       â”‚                    â”‚                    â”‚
       â”‚                    â”‚  broadcast IDR     â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                    â”‚                    â”‚
       â”‚  å¯ä»¥å¼€å§‹è§£ç !     â”‚                     â”‚
       â”‚                    â”‚                    â”‚
```

### 11.5 SPS/PPS ç¼“å­˜ç­–ç•¥

```rust
// ä¸»å¾ªç¯ä¸­çš„ SPS/PPS ç¼“å­˜
if frame.frame_type == FrameType::Config {
    let nal_type = frame.data[0] & 0x1F;

    if nal_type == 7 && !sps_cached {
        // SPS - åŒæ—¶è§£æåˆ†è¾¨ç‡
        let mut nal_with_start_code = vec![0x00, 0x00, 0x00, 0x01];
        nal_with_start_code.extend_from_slice(&frame.data);

        let mut config = video_config.write().await;
        config.sps = Some(Bytes::from(nal_with_start_code));

        // è§£æåˆ†è¾¨ç‡
        if let Some((w, h)) = parse_sps_resolution(&frame.data) {
            config.width = w;
            config.height = h;
        }
        sps_cached = true;
    } else if nal_type == 8 && !pps_cached {
        // PPS
        let mut nal_with_start_code = vec![0x00, 0x00, 0x00, 0x01];
        nal_with_start_code.extend_from_slice(&frame.data);

        let mut config = video_config.write().await;
        config.pps = Some(Bytes::from(nal_with_start_code));
        pps_cached = true;
    }
}
```

---

## 12. é…ç½®å‚æ•°è¯´æ˜

### 12.1 å‘½ä»¤è¡Œå‚æ•°

| å‚æ•°                     | çŸ­é€‰é¡¹ | é»˜è®¤å€¼                                  | è¯´æ˜                   |
| ------------------------ | ------ | --------------------------------------- | ---------------------- |
| `--adb-path`             | `-a`   | `../adb/adb.exe`                        | ADB å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„     |
| `--server-path`          | `-s`   | `../scrcpy-server/scrcpy-server-v3.3.4` | scrcpy-server JAR è·¯å¾„ |
| `--device`               | `-d`   | (è‡ªåŠ¨é€‰æ‹©)                              | ç›®æ ‡è®¾å¤‡åºåˆ—å·         |
| `--max-size`             | `-m`   | `1920`                                  | æœ€å¤§è§†é¢‘åˆ†è¾¨ç‡         |
| `--bit-rate`             | `-b`   | `4000000`                               | è§†é¢‘ç ç‡ (bps)         |
| `--max-fps`              | `-f`   | `60`                                    | æœ€å¤§å¸§ç‡               |
| `--ws-port`              | `-p`   | `8080`                                  | WebSocket ç«¯å£         |
| `--video-port`           |        | `27183`                                 | è§†é¢‘æµç«¯å£             |
| `--control-port`         |        | `27184`                                 | æ§åˆ¶æµç«¯å£             |
| `--intra-refresh-period` | `-i`   | `1`                                     | IDR å¸§é—´éš” (ç§’)        |
| `--log-level`            | `-l`   | `info`                                  | æ—¥å¿—çº§åˆ«               |

### 12.2 æ€§èƒ½è°ƒä¼˜å»ºè®®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ€§èƒ½è°ƒä¼˜å‚æ•°å»ºè®®                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  åœºæ™¯              â”‚ max_size â”‚ bit_rate  â”‚ max_fps â”‚ idr_interval      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  é«˜ç”»è´¨            â”‚  1920    â”‚ 8000000   â”‚   60    â”‚      2             â”‚
â”‚  å¹³è¡¡æ¨¡å¼          â”‚  1280    â”‚ 4000000   â”‚   60    â”‚      1             â”‚
â”‚  ä½å»¶è¿Ÿ            â”‚  1280    â”‚ 2000000   â”‚   60    â”‚      1             â”‚
â”‚  æµé‡èŠ‚çœ          â”‚   720    â”‚ 1000000   â”‚   30    â”‚      2             â”‚
â”‚                                                                         â”‚
â”‚  è¯´æ˜:                                                                   â”‚
â”‚  - max_size è¶Šå°,ç¼–ç è¶Šå¿«,å»¶è¿Ÿè¶Šä½                                        â”‚
â”‚  - bit_rate è¶Šé«˜,ç”»è´¨è¶Šå¥½,å¸¦å®½å ç”¨è¶Šå¤§                                    â”‚
â”‚  - idr_interval è¶Šå°,æ–°å®¢æˆ·ç«¯å¯åŠ¨è¶Šå¿«,ä½†å‹ç¼©æ•ˆç‡é™ä½                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 13. é”™è¯¯å¤„ç†

### 13.1 é”™è¯¯ç±»å‹å®šä¹‰

```rust
// src/error.rs
#[derive(Error, Debug)]
pub enum ScrcpyError {
    #[error("ADB error: {0}")]
    Adb(String),              // ADB å‘½ä»¤æ‰§è¡Œå¤±è´¥

    #[error("Device not found")]
    DeviceNotFound,           // è®¾å¤‡æœªæ‰¾åˆ°

    #[error("IO error: {0}")]
    Io(#[from] std::io::Error),  // IO é”™è¯¯

    #[error("Network error: {0}")]
    Network(String),          // ç½‘ç»œè¿æ¥é”™è¯¯

    #[error("Video stream error: {0}")]
    VideoStream(String),      // è§†é¢‘æµè§£æé”™è¯¯

    #[error("Parse error: {0}")]
    Parse(String),            // æ•°æ®è§£æé”™è¯¯
}

pub type Result<T> = std::result::Result<T, ScrcpyError>;
```

### 13.2 å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

| é”™è¯¯                                 | åŸå›                  | è§£å†³æ–¹æ¡ˆ                     |
| ------------------------------------ | -------------------- | ---------------------------- |
| `ADB not found`                      | ADB è·¯å¾„é”™è¯¯         | æ£€æŸ¥ `--adb-path` å‚æ•°       |
| `No devices connected`               | è®¾å¤‡æœªè¿æ¥           | æ£€æŸ¥ USB è¿æ¥æˆ– WiFi è°ƒè¯•    |
| `Server file not found`              | server JAR ä¸å­˜åœ¨    | æ£€æŸ¥ `--server-path` å‚æ•°    |
| `Failed to connect after 5 attempts` | ç«¯å£è½¬å‘å¤±è´¥         | é‡å¯ ADB æœåŠ¡                |
| `Buffer overflow`                    | è§†é¢‘æµç§¯å‹           | æé«˜å¤„ç†é€Ÿåº¦æˆ–é™ä½ç”»è´¨       |
| `WebSocket send failed`              | å®¢æˆ·ç«¯æ–­å¼€           | æ­£å¸¸æ–­å¼€,æ— éœ€å¤„ç†            |
| `No available port found`            | ç«¯å£èŒƒå›´å†…æ— å¯ç”¨ç«¯å£ | é‡Šæ”¾å ç”¨çš„ç«¯å£æˆ–è°ƒæ•´èµ·å§‹ç«¯å£ |

---

## 14. ç«¯å£è‡ªåŠ¨å¯»æ‰¾æœºåˆ¶

### 14.1 åŠŸèƒ½æ¦‚è¿°

å½“æŒ‡å®šçš„ç«¯å£è¢«å ç”¨æ—¶ï¼Œç¨‹åºä¼šè‡ªåŠ¨å‘åæœç´¢å¯ç”¨ç«¯å£ï¼Œæ— éœ€æ‰‹åŠ¨ä¿®æ”¹é…ç½®ã€‚è¿™åœ¨ä»¥ä¸‹åœºæ™¯ç‰¹åˆ«æœ‰ç”¨ï¼š

- åŒæ—¶è¿è¡Œå¤šä¸ª rust-scrcpy å®ä¾‹
- ç«¯å£è¢«å…¶ä»–ç¨‹åºå ç”¨
- ä¹‹å‰çš„å®ä¾‹æœªæ­£ç¡®é‡Šæ”¾ç«¯å£

### 14.2 ç«¯å£å·¥å…·æ¨¡å—

```rust
// src/utils/port.rs

/// æ£€æŸ¥ç«¯å£æ˜¯å¦å¯ç”¨
pub fn is_port_available(port: u16) -> bool {
    TcpListener::bind(("127.0.0.1", port)).is_ok()
}

/// ä»æŒ‡å®šç«¯å£å¼€å§‹ï¼Œå¯»æ‰¾ç¬¬ä¸€ä¸ªå¯ç”¨ç«¯å£
///
/// # Arguments
/// * `start_port` - èµ·å§‹ç«¯å£
/// * `max_attempts` - æœ€å¤§å°è¯•æ¬¡æ•°ï¼ˆå‘åæœç´¢çš„èŒƒå›´ï¼‰
///
/// # Returns
/// * `Ok(port)` - æ‰¾åˆ°çš„å¯ç”¨ç«¯å£
/// * `Err` - åœ¨èŒƒå›´å†…æœªæ‰¾åˆ°å¯ç”¨ç«¯å£
pub fn find_available_port(start_port: u16, max_attempts: u16) -> Result<u16> {
    let end_port = start_port.saturating_add(max_attempts);

    for port in start_port..=end_port {
        if is_port_available(port) {
            if port != start_port {
                info!("ğŸ“Œ Port {} is occupied, using port {} instead", start_port, port);
            }
            return Ok(port);
        }
    }

    Err(ScrcpyError::NoAvailablePort(start_port, end_port))
}

/// å¯»æ‰¾å¤šä¸ªè¿ç»­å¯ç”¨ç«¯å£
pub fn find_available_ports(start_port: u16, count: usize, max_attempts: u16) -> Result<Vec<u16>>;
```

### 14.3 ç«¯å£é…ç½®è¯´æ˜

| ç«¯å£ç±»å‹       | é»˜è®¤å€¼ | æœç´¢èŒƒå›´        | ç”¨é€”          |
| -------------- | ------ | --------------- | ------------- |
| Video Port     | 27183  | 27183-27283     | scrcpy è§†é¢‘æµ |
| Control Port   | 27184  | video_port+1 èµ· | scrcpy æ§åˆ¶æµ |
| WebSocket Port | 8080   | 8080-8180       | æµè§ˆå™¨è¿æ¥    |

### 14.4 å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç«¯å£è‡ªåŠ¨å¯»æ‰¾æµç¨‹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. ç”¨æˆ·é…ç½®ç«¯å£                                                         â”‚
â”‚     --ws-port 8080 --video-port 27183 --control-port 27184              â”‚
â”‚                                                                         â”‚
â”‚  2. æ£€æµ‹è§†é¢‘ç«¯å£                                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚     â”‚  27183 è¢«å ç”¨? â”€â”€Yesâ”€â”€> 27184 è¢«å ç”¨? â”€â”€Yesâ”€â”€> 27185...  â”‚         â”‚
â”‚     â”‚       â”‚                      â”‚                          â”‚         â”‚
â”‚     â”‚      No                     No                          â”‚         â”‚
â”‚     â”‚       â–¼                      â–¼                          â”‚         â”‚
â”‚     â”‚  ä½¿ç”¨ 27183              ä½¿ç”¨ 27184                      â”‚         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                         â”‚
â”‚  3. æ£€æµ‹æ§åˆ¶ç«¯å£ (ä» video_port + 1 å¼€å§‹)                                â”‚
â”‚     ç¡®ä¿æ§åˆ¶ç«¯å£ > è§†é¢‘ç«¯å£ï¼Œé¿å…å†²çª                                     â”‚
â”‚                                                                         â”‚
â”‚  4. æ£€æµ‹ WebSocket ç«¯å£                                                  â”‚
â”‚     ç‹¬ç«‹æ£€æµ‹ï¼Œä¸ scrcpy ç«¯å£æ— å…³                                          â”‚
â”‚                                                                         â”‚
â”‚  5. æ—¥å¿—è¾“å‡ºå®é™…ä½¿ç”¨çš„ç«¯å£                                                â”‚
â”‚     INFO: Video port: 27185 (requested: 27183)                          â”‚
â”‚     INFO: Control port: 27186 (requested: 27184)                        â”‚
â”‚     INFO: WebSocket server ready at ws://0.0.0.0:8080/ws                â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.5 å®é™…è¿è¡Œç¤ºä¾‹

```
2025-12-26T11:02:05.703681Z  INFO rust_scrcpy::utils::port: ğŸ“Œ Port 27183 is occupied, using port 27185 instead
2025-12-26T11:02:05.745795Z  INFO rust_scrcpy::scrcpy::server: ğŸš€ Starting scrcpy-server...
2025-12-26T11:02:05.745892Z  INFO rust_scrcpy::scrcpy::server:    Video port: 27185 (requested: 27183)
2025-12-26T11:02:05.745969Z  INFO rust_scrcpy::scrcpy::server:    Control port: 27186 (requested: 27184)
```

### 14.6 ScrcpyServer ç«¯å£ç®¡ç†

```rust
// src/scrcpy/server.rs

pub struct ScrcpyServer {
    video_port: u16,           // ç”¨æˆ·è¯·æ±‚çš„è§†é¢‘ç«¯å£
    actual_video_port: u16,    // å®é™…ä½¿ç”¨çš„è§†é¢‘ç«¯å£
    control_port: u16,         // ç”¨æˆ·è¯·æ±‚çš„æ§åˆ¶ç«¯å£
    actual_control_port: u16,  // å®é™…ä½¿ç”¨çš„æ§åˆ¶ç«¯å£
    // ...
}

impl ScrcpyServer {
    pub fn with_config(...) -> Result<Self> {
        // è‡ªåŠ¨å¯»æ‰¾å¯ç”¨ç«¯å£
        let actual_video_port = find_available_port(video_port, 100)?;

        // æ§åˆ¶ç«¯å£ä»è§†é¢‘ç«¯å£+1å¼€å§‹æœç´¢ï¼Œé¿å…å†²çª
        let actual_control_port = find_available_port(
            if control_port <= actual_video_port {
                actual_video_port + 1
            } else {
                control_port
            },
            100
        )?;

        Ok(Self { ... })
    }

    /// è·å–å®é™…ä½¿ç”¨çš„è§†é¢‘ç«¯å£
    pub fn get_actual_video_port(&self) -> u16 {
        self.actual_video_port
    }

    /// è·å–å®é™…ä½¿ç”¨çš„æ§åˆ¶ç«¯å£
    pub fn get_actual_control_port(&self) -> u16 {
        self.actual_control_port
    }
}
```

### 14.7 WebSocketServer ç«¯å£ç®¡ç†

```rust
// src/ws/server.rs

pub struct WebSocketServer {
    port: u16,          // ç”¨æˆ·è¯·æ±‚çš„ç«¯å£
    actual_port: u16,   // å®é™…ä½¿ç”¨çš„ç«¯å£
    // ...
}

impl WebSocketServer {
    pub fn new(port: u16, ...) -> Result<Self> {
        // è‡ªåŠ¨å¯»æ‰¾å¯ç”¨ç«¯å£
        let actual_port = find_available_port(port, 100)?;

        Ok(Self { port, actual_port, ... })
    }

    /// è·å–å®é™…ä½¿ç”¨çš„ç«¯å£
    pub fn get_actual_port(&self) -> u16 {
        self.actual_port
    }
}
```

### 14.8 é”™è¯¯å¤„ç†

å½“åœ¨æœç´¢èŒƒå›´å†…æ‰¾ä¸åˆ°å¯ç”¨ç«¯å£æ—¶ï¼Œä¼šè¿”å› `NoAvailablePort` é”™è¯¯ï¼š

```rust
// src/error.rs

#[derive(Error, Debug)]
pub enum ScrcpyError {
    // ...

    #[error("No available port found in range {0}-{1}")]
    NoAvailablePort(u16, u16),
}
```

---

## é™„å½•

### A. é¡¹ç›®æ–‡ä»¶ç»“æ„

```
rust-scrcpy/
â”œâ”€â”€ Cargo.toml              # é¡¹ç›®é…ç½®å’Œä¾èµ–
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs             # ä¸»ç¨‹åºå…¥å£ã€äº‹ä»¶å¾ªç¯ã€SPSè§£æ
â”‚   â”œâ”€â”€ error.rs            # é”™è¯¯ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ adb/
â”‚   â”‚   â”œâ”€â”€ mod.rs          # ADB æ¨¡å—å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ client.rs       # ADB å®¢æˆ·ç«¯å®ç°
â”‚   â”‚   â””â”€â”€ device.rs       # è®¾å¤‡ä¿¡æ¯ (coming soon)
â”‚   â”œâ”€â”€ scrcpy/
â”‚   â”‚   â”œâ”€â”€ mod.rs          # scrcpy æ¨¡å—å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ server.rs       # ScrcpyServer å®ç°
â”‚   â”‚   â”œâ”€â”€ video.rs        # è§†é¢‘æµè¯»å–å™¨
â”‚   â”‚   â””â”€â”€ control.rs      # æ§åˆ¶é€šé“å®ç°
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ mod.rs          # å·¥å…·æ¨¡å—å¯¼å‡º
â”‚   â”‚   â””â”€â”€ port.rs         # ç«¯å£å¯ç”¨æ€§æ£€æµ‹å’Œè‡ªåŠ¨å¯»æ‰¾
â”‚   â””â”€â”€ ws/
â”‚       â”œâ”€â”€ mod.rs          # WebSocket æ¨¡å—å¯¼å‡º
â”‚       â””â”€â”€ server.rs       # WebSocket æœåŠ¡å™¨å’Œ HTML é¡µé¢
â””â”€â”€ sum2.0.md               # æœ¬æŠ€æœ¯æ–‡æ¡£
```

### B. ä¾èµ–åº“è¯´æ˜

| ä¾èµ–      | ç‰ˆæœ¬ | ç”¨é€”                  |
| --------- | ---- | --------------------- |
| tokio     | 1.42 | å¼‚æ­¥è¿è¡Œæ—¶            |
| axum      | 0.7  | HTTP/WebSocket æœåŠ¡å™¨ |
| serde     | 1.0  | JSON åºåˆ—åŒ–           |
| bytes     | 1.9  | é«˜æ•ˆå­—èŠ‚ç¼“å†²          |
| tracing   | 0.1  | æ—¥å¿—ç³»ç»Ÿ              |
| clap      | 4.5  | å‘½ä»¤è¡Œå‚æ•°è§£æ        |
| thiserror | 2.0  | é”™è¯¯å¤„ç†              |

### C. å‚è€ƒèµ„æ–™

- [scrcpy å®˜æ–¹ä»“åº“](https://github.com/Genymobile/scrcpy)
- [WebCodecs API](https://developer.mozilla.org/en-US/docs/Web/API/WebCodecs_API)
- [Android InputManager](https://developer.android.com/reference/android/hardware/input/InputManager)

**ğŸ’æ„Ÿè°¢[Claude Opus 4.5](https://claude.ai)å’Œ[ChatGPT 5.2](https://chatgpt.com)å¸®æˆ‘é˜…è¯»scrcpyæºç å’Œåˆ†æscrcpyæµé‡åŒ…ğŸ’**
